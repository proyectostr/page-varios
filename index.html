<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="width=device-width" />
	<!-- <link href="/Content/bootstrap.min.css" rel="stylesheet" /> -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
		integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="/Content/HalcoLoader_V2.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://ctrz.halconet.com.mx/Assets/Template/Dashboard/assets/plugins/fontawesome-free/css/all.min.css"
		rel="stylesheet" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<link rel="stylesheet" href="css/disenoDevExtreme.css">
	<!-- <link rel="stylesheet" href="https://ctrz.halconet.com.mx/Content/devExtreme/dx.material.orange.light.compact.css">
 -->
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

	<script language="JScript" src="https://ctrz.halconet.com.mx/Scripts/linq.js"></script>
	<link rel="stylesheet" href="css/dx.material.orange.light.compact.css">

	<script src="https://ctrz.halconet.com.mx/Scripts/DevExtreme/jszip.js"></script>
	<script src="https://ctrz.halconet.com.mx/Scripts/DevExtreme/jszip.min.js"></script>
	<script src="https://ctrz.halconet.com.mx/Scripts/devextreme/dx-quill.min.js"></script>
	<script type="text/javascript" src="https://ctrz.halconet.com.mx/Scripts/DevExtreme/dx.all.js"></script>
	<!--  <script src="https://ctrz.halconet.com.mx/JS/DX_devextreme-license.js"></script> -->
	<script src="https://ctrz.halconet.com.mx/Scripts/devextreme/localization/dx.messages.es.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/7.4.0/polyfill.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.0.1/exceljs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.2/FileSaver.min.js"></script>
	<script src="https://ctrz.halconet.com.mx/JS/Fetch.js"></script>
	<script src="https://ctrz.halconet.com.mx/JS/DX_GenericFunctions.js"></script>

	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

	<style>
		body {
			background-color: #f0f2f5;
		}

		.chat-box {
			max-height: 400px;
			overflow-y: auto;
			padding: 10px;
			background: #ffffff;
			border-radius: 10px;
		}

		.chat-message {
			display: flex;
			align-items: flex-end;
			margin-bottom: 5px;
			width: 100%;
		}

		.chat-message.bot {
			justify-content: flex-start;
		}

		.chat-message.user {
			justify-content: flex-end;
		}

		.chat-bubble {
			padding: 12px;
			border-radius: 18px;
			max-width: 70%;
			font-size: 14px;
			box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
			position: relative;
		}

		.bot .chat-bubble {
			background-image: linear-gradient(to right, #88b9ed, #0d437d);
			/* Degradado azul */
			color: white;
		}

		.user .chat-bubble {
			background-image: linear-gradient(to right, #62161e, #cc2030);
			/* Degradado rojo */
			color: white;
		}

		.chat-icon {
			width: 40px;
			height: 40px;
			background: #e4e6eb;
			border-radius: 50%;
			display: flex;
			justify-content: center;
			align-items: center;
			font-size: 18px;
			margin: 0 10px;
		}

		.chat-message.user .chat-icon {
			background: #dc3545;
			color: white;
		}

		.chat-message.bot .chat-icon {
			background: #007bff;
			color: white;
		}

		.modal-title {
			width: 100%;
			text-align: center;
		}

		.small-date {
			font-size: 10px;
			color: white;
			/* Color blanco para la fecha */
		}
	</style>

	<style>
		/* Establece el estilo a los encabezados de la tabla */
		.dx-datagrid-headers .dx-datagrid-table .dx-row>td {
			background-color: #44546a;
			color: white;
			text-align: left !important;
		}

		/* mueve los iconos de filtro a la derecha */
		.dx-datagrid .dx-column-indicators {
			float: right !important;
		}

		/* establece el estilo a los filtros del encabezado */
		.dx-datagrid .dx-datagrid-table .dx-datagrid-filter-row>td {
			background-color: #fff;
		}

		/* establece el color al colocar el puntero sobre el encabezado */
		.dx-datagrid-headers .dx-datagrid-table .dx-row>td .dx-sort,
		.dx-datagrid-headers .dx-datagrid-table .dx-row>td .dx-sort-indicator,
		.dx-datagrid-headers .dx-datagrid-table .dx-row>td:hover .dx-datagrid-text-content {
			color: white !important;
		}

		.dx-datagrid-headers .dx-datagrid-table .dx-row>td:hover:not(.dx-command-select):not(.dx-command-expand):not(.dx-editor-cell):not(.dx-command-edit):not(.dx-datagrid-group-space) {
			background-color: #44546a !important;
		}

		/* cambia el padding de la fila */
		.dx-datagrid .dx-row>td {
			padding-top: 5px;
			padding-left: 10px;
			padding-bottom: 5px;
			padding-right: 10px;
		}

		/* establece el estilo del icono del encabezado */
		.dx-datagrid .dx-header-filter,
		.dx-datagrid .dx-sort-down,
		.dx-datagrid .dx-sort-up,
		.dx-datagrid-container .dx-header-filter,
		.dx-datagrid-container .dx-sort-down,
		.dx-datagrid-container .dx-sort-up {
			color: white;
		}

		/* establece el estilo para la flecha de indicador de orden */
		.dx-datagrid-headers .dx-datagrid-table .dx-row>td:hover .dx-sort {
			color: white;
			float: right !important;
		}

		.dx-datagrid-nowrap,
		.dx-datagrid-nowrap .dx-header-row>td>.dx-datagrid-text-content {
			white-space: break-spaces !important;
			padding: 0px;
		}

		.dx-datagrid-table,
		.dx-datagrid-table-fixed {
			white-space: nowrap !important;
		}

		.dx-datagrid .dx-row>td {
			font-size: 12px !important;
		}

		.dx-datagrid .dx-datagrid-table .dx-header-row>td {
			padding: .5em .6em .4em .6em !important;
			font-weight: 400 !important;
			font-family: Roboto, sans-serif !important;
			font-size: 12px !important;
		}



		.halcoloader {
			width: 100%;
			height: 100%;
			position: absolute;
			top: 0;
			left: 0;
			background-color: #fff;
			z-index: 10000;
			overflow: hidden;
			visibility: hidden;
			opacity: 0;
		}

		.halcoloader.active {
			opacity: 0.9;
			visibility: visible;
		}

		.halcoloader-logo {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}

		path#Trazado_1 {
			stroke: url(#linear-gradient);
			fill: none;
			stroke-dasharray: 1800;
			stroke-dasharray: 2855;
			opacity: 10;
			animation: animationThree 2.5s cubic-bezier(0.65, 0.05, 0.36, 1) infinite alternate;
		}


		#Trazado_3,
		#Trazado_4,
		#Trazado_5,
		#Trazado_6 {
			animation: animationOne .8s cubic-bezier(0.65, 0.05, 0.36, 1) infinite alternate;
		}


		#Trazado_7,
		#Trazado_8 {
			animation: animationOne .8s cubic-bezier(0.65, 0.05, 0.36, 1) infinite alternate;
		}

		@keyframes animationOne {
			0% {
				opacity: 0;
			}

			100% {
				opacity: 1;
			}
		}

		@keyframes animationTwo {
			0% {
				opacity: 0;
				fill: #fff;
			}

			100% {
				opacity: 100;
				fill: url(#linear-gradient-2);
			}
		}

		@keyframes animationThree {
			0% {
				opacity: 0;
				fill: none;
				stroke-dashoffset: 0;
			}

			100% {
				opacity: 10;
				stroke-dashoffset: 2855;
			}
		}
	</style>


	<style>
		/* Estilo para el switch compacto */
		.custom-switch {
			position: relative;
			display: inline-block;
			width: 50px;
			/* Ancho más pequeño */
			height: 25px;
			/* Altura más pequeña */
		}

		/* Ocultar el input original */
		.custom-switch input {
			opacity: 0;
			width: 0;
			height: 0;
		}

		/* Estilo de la pista del switch */
		.slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #dee2e6;
			/* Fondo desactivado */
			transition: 0.3s;
			border-radius: 25px;
		}

		/* Círculo dentro del switch */
		.slider:before {
			position: absolute;
			content: "";
			height: 18px;
			/* Tamaño del círculo reducido */
			width: 18px;
			left: 3px;
			bottom: 3px;
			background-color: white;
			transition: 0.3s;
			border-radius: 50%;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
			/* Sombra del círculo */
		}

		/* Cambio de color al activarse */
		input:checked+.slider {
			background-color: #0d6efd;
			/* Azul Bootstrap */
		}

		/* Movimiento del círculo al activarse */
		input:checked+.slider:before {
			transform: translateX(25px);
			/* Movimiento del círculo ajustado */
		}

		/* Etiqueta personalizada */
		.switch-label {
			font-size: 1rem;
			/* Tamaño de texto ajustado */
			margin-left: 10px;
			vertical-align: middle;
		}
	</style>

	<style>
		.btn-danger:hover {
			background-color: #dc3545 !important;
			border-color: #dc3545 !important;
		}
	</style>
</head>

<body>

	<!-- Modal -->
	<div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true"
		data-bs-backdrop="static" data-bs-keyboard="false">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="chatModalLabel">Chat</h5>
					<!-- Botón de cierre con control manual -->
					<button type="button" class="btn-close" id="chatCloseButton" aria-label="Close"></button>
				</div>
				<div class="modal-body chat-box" id="chatContainer">
				</div>
				<div class="modal-footer">
					<!-- Botón para cerrar el modal -->
					<button type="button" class="btn btn-secondary" id="chatCloseFooterButton">Cerrar</button>
				</div>
			</div>
		</div>
	</div>

	<div class="containers mt-5">
		<!-- Pestañas de navegación -->
		<ul class="nav nav-tabs" id="myTab" role="tablist">
			<li class="nav-item" role="presentation">
				<a class="nav-link active" id="calculo-tab" data-bs-toggle="tab" href="#calculo" role="tab"
					aria-controls="calculo" aria-selected="true">
					<i class="bi bi-calculator"></i> Cálculo
				</a>
			</li>
			<li class="nav-item" role="presentation">
				<a class="nav-link" id="consulta-tab" data-bs-toggle="tab" href="#consulta" role="tab"
					aria-controls="consulta" aria-selected="false">
					<i class="bi bi-search"></i> Consulta
				</a>
			</li>
		</ul>

		<!-- Contenido de las pestañas -->
		<div class="tab-content" id="myTabContent">
			<div class="tab-pane fade show active" id="calculo" role="tabpanel" aria-labelledby="calculo-tab">

				<div id="ContainerBody" style="display: none;">
					<div class="module-title">
						<div class="line"></div>
						<strong id="titleModule"> </strong>
						<div class="line bottom"></div>
					</div>

					<div class="content">

						<div id="container-view" class="container-fluid">


							<script src="https://ctrz.halconet.com.mx/Scripts/xlsx.full.min.js"></script>
							<script src="https://ctrz.halconet.com.mx/Scripts/DevExtreme/exceljs.min.js"></script>
							<fieldset class="p-3">
								<legend> <span class="material-icons"> filter_list </span></legend>
								<div class="row">
									<div class="col-lg-2 col-sm-12 mb-2">
										<b>Ingresa factor:</b>
										<div id="dtFactor"></div>
									</div>

									<div class="col-lg-2 col-sm-12 mb-2">
										<b>Costo Combustible:</b>
										<div id="dtCombustible"></div>
									</div>
									<div class="col-lg-2 col-sm-12 mb-2" style="display: none;">
										<b>Tipo Calculo:</b>
										<div id="dtTipoCalculo"></div>
									</div>
									<div class="col-lg-3 col-sm-12 mb-2">
										<b>Carga Documento:</b>
										<div id="fileUploaderContainer" style="display: initial;"></div>
									</div>
									<div class="col-lg-1 col-sm-12 mb-2">
										<br>
										<div id="btnInfoTemplate"></div>
									</div>
									<div class="col-lg-3 col-sm-12 mb-3">
										<br>
										<div id="btnInfoCalculoUnitario"></div>
									</div>


								</div>
							</fieldset>
							<div class="container-info">
								<div id="gridContainerSiniestro" style="height: 230px !important;"></div>
							</div>
							<div id="divInfoTemplate">
								<table id="idtableTemplate">
									<thead id="tableEncabezado">
										<tr>
											<th style="width: 10%;" class="valoresTabla">origen</th>
											<th style="width: 10%;" class="valoresTabla">destino</th>
											<th style="width: 10%;" class="valoresTabla">marca</th>
											<th style="width: 10%;" class="valoresTabla">modelo</th>

											<th style="width: 10%;" class="valoresTabla">consumo</th>
											<th style="width: 20%;" class="valoresTabla">numero_ejes</th>
											<th style="width: 20%;" class="valoresTabla">tipo_consumo</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td class="valoresTabla">Texto plano</td>
											<td class="valoresTabla">Texto plano</td>
											<td class="valoresTabla">Texto plano</td>
											<td class="valoresTabla">Texto plano</td>
											<td class="valoresTabla">Número decimal</td>
											<td class="valoresTabla">Número entero</td>
											<td class="valoresTabla" style="width: 20%;">texto plano</td>
										</tr>
									</tbody>
								</table>
							</div>
							<style>
								.dx-popup-content {
									overflow-y: auto;
									overflow-x: auto;
								}

								#idtableTemplate {
									width: 100%;
									border-collapse: collapse;
								}

								#tableEncabezado {
									background-color: aliceblue
								}

								.valoresTabla {
									border: 1px solid black;
									padding: 8px;
									text-align: left;
								}

								.red {
									color: red !important;
								}
							</style>


						</div>
					</div>


				</div>



			</div>
			<div class="tab-pane fade" id="consulta" role="tabpanel" aria-labelledby="consulta-tab">


				<div id="ContainerBody" style="display: initial;">
					<div class="module-title">
						<div class="line"></div>
						<strong id="titleModuleConsulta">Consulta registro</strong>
						<div class="line bottom"></div>
					</div>

					<div class="content">

						<div id="container-view" class="container-fluid">

							<fieldset class="p-3">
								<legend> <span class="material-icons"> filter_list </span></legend>
								<div class="row">
									<div class="col-lg-3 col-sm-12 mb-3">
										<b>Rango de fechas:</b>
										<div id="rangoFechas"></div>
									</div>

									<div class="col-lg-2 col-sm-12 mb-2">
										<b>Busqueda por nombre:</b>
										<input type="text" id="txtBusquedaNombre" class="form-control">
									</div>


									<div class="col-lg-4 col-sm-12 mb-4">
										<br>
										<div id="btnInfoConsultaRegistros"></div>
									</div>
								</div>
							</fieldset>
							<div class="container-info">
								<div id="gridContainerConsultaRegistros" style="height: 230px !important;"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="halcoloader h-letras"></div>


	<!-- DevExtreme dxPopup Modal -->
	<div id="myModal" class="dx-popup">
		<div id="modalContent">
			<iframe id="modalIframe" src="" width="100%" height="400px"></iframe>
		</div>
	</div>


	<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"
		data-bs-backdrop="static">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title w-100 text-center" id="exampleModalLabel">Formulario de Datos</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>


				<div class="modal-body">

					<div class="mb-3">

						<div class="d-flex justify-content-end">
							<!-- Switch personalizado -->
							<label class="custom-switch">
								<input type="checkbox" checked="true" id="chkLlenadoAutomatico"
									onchange="checkSwitchValue()">
								<span class="slider"></span>
							</label>
							<span class="switch-label ms-2">prellenado automático</span>
						</div>
					</div>

					<div class="mb-3" style="display: initial;">
						<label for="formulario" class="form-label">Datos Formularios</label>
						<div id="dropdown"></div>
					</div>

					<div class="mb-3 p-3" id="dataFormulario"
						style="display: none; margin-top: 10px; background-color: #f8f9fa; border: 2px solid #007bff; border-radius: 8px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);">
						<!-- Botón de cierre -->
						<button type="button" id="btnCerrar" class="btn-close position-absolute" style="right: 7%;"
							aria-label="Close"></button>

						<label for="formulario" class="form-label text-center d-block"
							style="font-weight: bold;">Información</label>
						<p><b>Nombre:</b> <a style="text-decoration: none;" id="txtnombrefrm"></a></p>
						<p><b>Correo:</b> <a style="text-decoration: none;" id="txtcorreofrm"></a></p>
						<p><b>Teléfono:</b> <a style="text-decoration: none;" id="txttelefonofrm"></a></p>
						<p><b>Datos vehículo:</b> <a style="text-decoration: none;" id="txtdatosvehiculofrm"></a></p>
						<p><b>Origen:</b> <a style="text-decoration: none;" id="txtorigenfrm"></a></p>
						<p><b>Destino:</b> <a style="text-decoration: none;" id="txtdestinofrm"></a></p>
						<p><b>cilindros:</b> <a style="text-decoration: none;" id="txtcilindrosfrm"></a></p>
						<p><b>Caracteristicas:</b> <a style="text-decoration: none;" id="txtcaracteristicasfrm"></a></p>
						<p><b>Fecha:</b> <a style="text-decoration: none;" id="txtfechafrm"></a></p>
					</div>

					<div class="mb-3">
						<label for="origen" class="form-label">Origen</label>
						<input type="text" class="form-control validar-campo-formulario-datos" id="origen" value=""
							autocomplete="off">
						<div class="invalid-feedback">El origen debe contener una coma seguida de texto.</div>
					</div>
					<div class="mb-3">
						<label for="destino" class="form-label">Destino</label>
						<input type="text" class="form-control validar-campo-formulario-datos" id="destino" value=""
							autocomplete="off">
						<div class="invalid-feedback">El destino debe contener una coma seguida de texto.</div>
					</div>
					<div class="mb-3">
						<label for="marca" class="form-label">Marca</label>
						<input type="text" class="form-control validar-campo-formulario-datos" id="marca" value=""
							autocomplete="off">
						<div class="invalid-feedback">Por favor ingrese la marca.</div>
					</div>
					<div class="mb-3">
						<label for="modelo" class="form-label">Modelo</label>
						<input type="text" class="form-control validar-campo-formulario-datos" id="modelo" value=""
							autocomplete="off">
						<div class="invalid-feedback">Por favor ingrese el modelo.</div>
					</div>
					<div class="mb-3" style="display: none;">
						<label for="numero_cilindros" class="form-label">Número de Cilindros</label>
						<input type="number" class="form-control validar-campo-formulario-datos" id="numero_cilindros"
							value="-1">
						<div class="invalid-feedback">Por favor ingrese un número mayor a -1 o deje el campo vacío.
						</div>
					</div>
					<div class="mb-3">
						<label for="consumo" class="form-label">Consumo</label>
						<input type="number" class="form-control validar-campo-formulario-datos" id="consumo" value="">
						<div class="invalid-feedback">El consumo debe ser mayor o igual a 1 o estar vacío.</div>
					</div>
					<div class="mb-3">
						<label for="numero_ejes" class="form-label">Número de Ejes</label>
						<select class="form-select validar-campo-formulario-datos" id="numero_ejes">
							<option value="2">2</option>
							<option value="3">3</option>
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
						</select>
						<div class="invalid-feedback">Por favor seleccione un número de ejes válido.</div>
					</div>
					<div class="mb-3">
						<label for="precio_combustible" class="form-label">Precio del Combustible</label>
						<input type="number" class="form-control validar-campo-formulario-datos" id="precio_combustible"
							value="" step="0.01">
						<div class="invalid-feedback">Por favor ingrese el precio del combustible.</div>
					</div>
					<div class="mb-3">
						<label for="factor" class="form-label">Factor</label>
						<input type="number" class="form-control validar-campo-formulario-datos" id="factor" value="1">
						<div class="invalid-feedback">Por favor ingrese el factor.</div>
					</div>
					<div class="mb-3">
						<label for="tipo_consumo" class="form-label">Tipo de Consumo</label>
						<select class="form-select validar-campo-formulario-datos" id="tipo_consumo">
							<option value="" selected disabled>Seleccione un tipo de consumo</option>
							<option value="consumo bajo">Consumo Bajo</option>
							<option value="consumo medio">Consumo Medio</option>
							<option value="consumo alto">Consumo Alto</option>
							<option value="consumo extra">Consumo Extra</option>
							<option value="consumo camiones">Consumo Camiones</option>
						</select>
						<div class="invalid-feedback">Por favor seleccione un tipo de consumo.</div>
					</div>
					<div class="mb-3" style="display: none;">
						<label for="id_correo" class="form-label">Id correo</label>
						<input type="number" class="form-control validar-campo-formulario-datos" id="id_correo"
							value="-1">
						<div class="invalid-feedback">Por favor ingrese un valor ID.</div>
					</div>
					<div class="mb-3" style="display: none;">
						<label for="correo_frm" class="form-label">Correo</label>
						<input type="text" class="form-control validar-campo-formulario-datos" id="correo_frm" value="">
						<div class="invalid-feedback">Por favor ingrese un correo.</div>
					</div>
					<div class="mb-3" style="display: none;">
						<label for="telefono_frm" class="form-label">telefono</label>
						<input type="text" class="form-control validar-campo-formulario-datos" id="telefono_frm"
							value="">
						<div class="invalid-feedback">Por favor ingrese un telefono.</div>
					</div>
					<div class="mb-3" style="display: none;">
						<label for="nombre_frm" class="form-label">nombre</label>
						<input type="text" class="form-control validar-campo-formulario-datos" id="nombre_frm" value="">
						<div class="invalid-feedback">Por favor ingrese un telefono.</div>
					</div>
				</div>
				<div class="modal-footer">
					<div class="text-start">
						<button type="button" id="btnRechazarAntiguedad" class="btn btn-danger">Rechazar por
							antiguedad</button>
					</div>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
					<button type="button" class="btn btn-primary" id="btnGenerar">Generar</button>


				</div>
			</div>
		</div>
	</div>

	<!-- Modal -->
	<div class="modal fade" id="envioDeCorreo" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true"
		data-bs-backdrop="static" data-bs-keyboard="false">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<!-- Título centrado -->
					<h5 class="modal-title w-100 text-center" id="modalLabel">Formulario de Envío</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
				</div>
				<div class="modal-body">
					<!-- Campos de entrada -->
					<div class="mb-3">
						<label for="nombre" class="form-label">Nombre</label>
						<input type="text" class="form-control validar-campo" id="nombre"
							placeholder="Ingresa tu nombre" data-error="Por favor, ingresa tu nombre."
							autocomplete="off">
						<div class="invalid-feedback">Por favor, ingresa tu nombre.</div>
					</div>
					<div class="mb-3">
						<label for="correo" class="form-label">Correo Electrónico</label>
						<input type="email" class="form-control validar-campo" id="correo"
							placeholder="Ingresa tu correo" data-error="Por favor, ingresa un correo válido."
							autocomplete="off">
						<div class="invalid-feedback">Por favor, ingresa un correo válido.</div>
					</div>
					<div class="mb-3">
						<label for="telefono" class="form-label">Teléfono</label>
						<input type="text" class="form-control validar-campo" id="telefono"
							placeholder="Ingresa tu teléfono" data-error="Por favor, ingresa tu teléfono."
							autocomplete="off">
						<div class="invalid-feedback">Por favor, ingresa tu teléfono.</div>
					</div>

					<!-- Nuevo checkbox agregado -->
					<div class="mb-3 form-check" style="display: none;">
						<input type="checkbox" class="form-check-input" id="trasladoPeligroso">
						<label class="form-check-label" for="trasladoPeligroso">Traslado Peligroso</label>
					</div>
					<div class="mb-3 form-check">
						<input type="checkbox" class="form-check-input" id="trasladoFlex">
						<label class="form-check-label" for="trasladoFlex">Traslado Flex</label>
					</div>
					<div class="mb-3" style="display: none;">
						<label for="txtIdCorreoEnvio" class="form-label">Id Correo</label>
						<input type="number" class="form-control validar-campo" id="txtIdCorreoEnvio">
					</div>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
					<button type="button" class="btn btn-primary" id="btnEnviar">Enviar</button>
					<button type="button" class="btn btn-primary" id="btnGenerarPdf">generar pdf</button>
				</div>
			</div>
		</div>
	</div>


	<script src="js/Load.js"></script>

	<script>
		DevExpress.localization.locale('es-MX');
		DevExpress.config({ defaultCurrency: 'MXN' });
		// Función para abrir el modal con la URL proporcionada

	</script>


	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

	<script>

		var urlEndPoint = 'https://pasarelaconwait-response-1.onrender.com';
		//var urlEndPoint = 'http://localhost:3001';
		document.getElementById('btnGenerar').addEventListener('click', function () {
			let inputs = document.querySelectorAll('.modal-body .form-control, .modal-body .form-select');
			let isValid = true;
			let data = {};

			inputs.forEach(input => {
				const id = input.id;
				const value = input.value;

				if ((id === 'origen' || id === 'destino') && (!value.includes(',') || value.split(',')[1].trim() === '')) {
					input.classList.add('is-invalid');
					isValid = false;
				} else if (id === 'consumo' && value !== '' && parseFloat(value) < 1) {
					input.classList.add('is-invalid');
					isValid = false;
				} else if (id === 'numero_ejes' && value === '') {
					input.classList.add('is-invalid');
					isValid = false;
				} else if (id === 'tipo_consumo' && value === '') {
					input.classList.add('is-invalid');
					isValid = false;
				} else if (id === 'marca' && value === '') {
					input.classList.add('is-invalid');
					isValid = false;
				} else if (id === 'modelo' && value === '') {
					input.classList.add('is-invalid');
					isValid = false;
				} else if (id === 'precio_combustible' && value === '') {
					input.classList.add('is-invalid');
					isValid = false;
				}
				else if (id === 'factor' && value === '') {
					input.classList.add('is-invalid');
					isValid = false;
				}
				else {
					input.classList.remove('is-invalid');
					input.classList.add('is-valid');
					data[id] = value;
				}
			});

			if (isValid) {
				//   alert('Formulario válido. JSON generado en la consola.');

				data.numero_cilindros = parseInt(data.numero_cilindros, 10); // Convertir a entero
				data.numero_ejes = parseInt(data.numero_ejes, 10); // Convertir a entero
				data.precio_combustible = parseFloat(data.precio_combustible); // Convertir a decimal
				data.factor = parseFloat(data.factor); // Convertir a decimal
				data.consumo = parseFloat(data.consumo) > 0 ? parseFloat(data.consumo) : 0; // Convertir a decimal
				data.id_correo = parseInt(data.id_correo, 10);
				console.log(data);
				obtenerFacturasTemplate([data], 2);
			} else {
				let message = 'Por favor completa todos los campos correctamente.'
				DevExpress.ui.notify({ message, width: 450, }, "error", 4000);
				//alert();
			}
		});





		$("#btnRechazarAntiguedad").dxButton({
			text: "Mostrar Confirmación",
			onClick: function () {
				DevExpress.ui.dialog.confirm("¿Estás seguro de realizar esta acción?", "Confirmación")
					.then(function (dialogResult) {
						if (dialogResult) {
							//  DevExpress.ui.notify("¡Confirmado!", "success", 2000);
							fetch(urlEndPoint + '/ventas/data-form-send-rechazar', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json', // Indicamos que el cuerpo de la solicitud es JSON
								},
								body: JSON.stringify({
									id_correo: parseInt(document.getElementById('id_correo').value) // Datos que deseas enviar en el cuerpo de la solicitud
								}),
							})
								.then(response => response.json()) // Convertimos la respuesta a JSON
								.then(data => {
									cargarCorreosFormulario();
									DevExpress.ui.notify("¡Respuesta enviada!", "success", 2000);
									console.log('Respuesta del servidor:', data); // Maneja la respuesta del servidor
								})
								.catch(error => {
									console.error('Error en la petición:', error); // Maneja errores si ocurren
								});
						}
					});
			}
		});


	</script>

	<script>
		// Botón de envío
		const btnEnviar = document.getElementById('btnEnviar');

		// Manejo del clic en el botón "Enviar"
		btnEnviar.addEventListener('click', async () => {
			const campos = document.querySelectorAll('.validar-campo'); // Selecciona todos los campos a validar
			let esValido = true;

			// Iterar sobre los campos y validarlos
			for (let campo of campos) {
				if (!campo.value.trim() || (campo.type === 'email' && !campo.value.includes('@'))) {
					campo.classList.add('is-invalid'); // Marca el campo como inválido
					campo.nextElementSibling.textContent = campo.getAttribute('data-error'); // Actualiza el mensaje de error
					esValido = false;
				} else {
					campo.classList.remove('is-invalid'); // Elimina el estado de inválido
					campo.classList.add('is-valid'); // Marca el campo como válido
				}
			}

			if (esValido) {


				const nombre = document.getElementById('nombre').value;
				const correo = document.getElementById('correo').value;
				const telefono = document.getElementById('telefono').value;
				const idCorreoFormulario = parseInt(document.getElementById('txtIdCorreoEnvio').value);
				// Obtener el checkbox por su id
				const trasladoPeligroso = document.getElementById('trasladoPeligroso').checked;
				const trasladoFlex = document.getElementById('trasladoFlex').checked;


				const url = urlEndPoint + '/ventas/envio-cotizacion-preliminar-camiones-automoviles'; // URL de la API donde se enviarán los datos
				const datos = {
					tipo_cotizacion: "agendar_cotizacion_ia_preliminar",
					nombre: nombre, // Datos que se van a enviar
					correo: correo,
					telefono: telefono,
					tipo_correo: "Envio",
					guid: guid_envio_mod,
					id: id_envio_mod,
					precio_Combustible_mod: precio_Combustible_mod,
					factor_mod: factor_mod,
					kilometros_mod: kilometros_mod,
					casetas_Peajes_mod: casetas_Peajes_mod,
					transporte_Origen_mod: transporte_Origen_mod,
					transporte_Destino_mod: transporte_Destino_mod,
					taxis_UBER_mod: taxis_UBER_mod,
					material_Bono_Extra_mod: material_Bono_Extra_mod,
					costo_ferry_mod: costo_ferry_mod,
					traslado_peligroso: trasladoPeligroso,
					id_correo_formulario: idCorreoFormulario,
					traslado_flex: trasladoFlex

				};

				try {
					halcoloaderActive();
					// Realizar la solicitud POST
					const response = await fetch(url, {
						method: 'POST', // Especificar que es una solicitud POST
						headers: {
							'Content-Type': 'application/json', // Establecer el tipo de contenido que se enviará
						},
						body: JSON.stringify(datos), // Convertir los datos a formato JSON antes de enviarlos
					});

					// Verificar si la respuesta es exitosa (código de estado 2xx)
					if (!response.ok) {
						// Si la respuesta no es exitosa, lanzar un error con el código de estado
						throw new Error(`Error HTTP: ${response.status}`);
					}

					// Convertir la respuesta a formato JSON (suponiendo que la API responde con JSON)
					const responseData = await response.json();

					// Mostrar la respuesta de la API
					console.log('Respuesta de la API:', responseData);
					if (responseData.valid) {
						cargarCorreosFormulario();
						halcoloaderRemove();

						let message = 'Envio correcto'
						DevExpress.ui.notify({ message, width: 450, }, "success", 4000);

						for (let campo of campos) {
							campo.value = '';
							campo.classList.remove('is-valid');
							campo.classList.remove('is-invalid');
						}

						document.getElementById('trasladoPeligroso').checked = false;
						document.getElementById('trasladoFlex').checked = false;
						// Cierra el modal
						const modal = bootstrap.Modal.getInstance(document.getElementById('envioDeCorreo'));
						modal.hide();
					} else {
						let ms = responseData.data;
						DevExpress.ui.notify({ ms, width: 450, }, "error", 4000);
					}

				} catch (error) {
					// Manejo de errores
					if (error.name === 'TypeError') {
						let ms = error.message;
						// Esto ocurre si hay problemas de red o si la URL es incorrecta


						DevExpress.ui.notify({ ms, width: 450, }, "error", 4000);
						console.error('Problema de red o URL incorrecta:', error.message);
					} else if (error.message.startsWith('Error HTTP')) {
						// Si hubo un error HTTP (código de estado no 2xx)
						let ms = error.message;
						// Esto ocurre si hay problemas de red o si la URL es incorrecta
						DevExpress.ui.notify({ ms, width: 450, }, "error", 4000);
						console.error('Hubo un error al enviar los datos:', error.message);
					} else {
						let ms = error.message;
						// Esto ocurre si hay problemas de red o si la URL es incorrecta
						DevExpress.ui.notify({ ms, width: 450, }, "error", 4000);
						// Manejo de otros errores
						console.error('Error desconocido:', error.message);
					}
					halcoloaderRemove();
				}



			}
		});

	</script>



	<script>
		// Botón de envío
		const btnGenerar = document.getElementById('btnGenerarPdf');

		// Manejo del clic en el botón "Enviar"
		btnGenerar.addEventListener('click', async () => {
			const campos = document.querySelectorAll('.validar-campo'); // Selecciona todos los campos a validar
			let esValido = true;

			if (esValido) {
				const nombre = document.getElementById('nombre').value;
				const correo = document.getElementById('correo').value;
				const telefono = document.getElementById('telefono').value;
				// Obtener el checkbox por su id
				const trasladoPeligroso = document.getElementById('trasladoPeligroso').checked;
				const trasladoFlex = document.getElementById('trasladoFlex').checked;
				const idCorreoFormulario = parseInt(document.getElementById('txtIdCorreoEnvio').value);

				const url = urlEndPoint + '/ventas/pdf-cotizacion-preliminar-camiones-automoviles'; // URL de la API donde se enviarán los datos
				const datos = {
					tipo_cotizacion: "agendar_cotizacion_ia_preliminar",
					nombre: nombre == '' ? "cliente" : nombre, // Datos que se van a enviar
					correo: correo == '' ? "soporte@trasladista.com" : correo,
					telefono: telefono,
					tipo_correo: "Envio",
					guid: guid_envio_mod,
					id: id_envio_mod,
					precio_Combustible_mod: precio_Combustible_mod,
					factor_mod: factor_mod,
					kilometros_mod: kilometros_mod,
					casetas_Peajes_mod: casetas_Peajes_mod,
					transporte_Origen_mod: transporte_Origen_mod,
					transporte_Destino_mod: transporte_Destino_mod,
					taxis_UBER_mod: taxis_UBER_mod,
					material_Bono_Extra_mod: material_Bono_Extra_mod,
					costo_ferry_mod: costo_ferry_mod,
					traslado_peligroso: trasladoPeligroso,
					id_correo_formulario: idCorreoFormulario,
					traslado_flex: trasladoFlex

				};

				try {
					halcoloaderActive();
					// Realizar la solicitud POST
					const response = await fetch(url, {
						method: 'POST', // Especificar que es una solicitud POST
						headers: {
							'Content-Type': 'application/json', // Establecer el tipo de contenido que se enviará
						},
						body: JSON.stringify(datos), // Convertir los datos a formato JSON antes de enviarlos
					});

					// Verificar si la respuesta es exitosa (código de estado 2xx)
					if (!response.ok) {
						// Si la respuesta no es exitosa, lanzar un error con el código de estado
						throw new Error(`Error HTTP: ${response.status}`);
					}

					// Convertir la respuesta a formato JSON (suponiendo que la API responde con JSON)
					const responseData = await response.json();

					// Mostrar la respuesta de la API
					console.log('Respuesta de la API:', responseData);
					if (responseData.valid) {

						// Convertir Base64 a Blob
						const base64Data = responseData.data;
						const binaryString = atob(base64Data); // Decodifica Base64 a binario
						const byteArray = new Uint8Array(binaryString.length);
						for (let i = 0; i < binaryString.length; i++) {
							byteArray[i] = binaryString.charCodeAt(i);
						}
						const pdfBlob = new Blob([byteArray], { type: 'application/pdf' });

						// Crear enlace de descarga
						const pdfUrl = URL.createObjectURL(pdfBlob);
						const link = document.createElement('a');
						link.href = pdfUrl;
						link.download = 'cotizacion- IA - ' + nombre + '.pdf';
						document.body.appendChild(link);
						link.click();

						// Liberar memoria
						URL.revokeObjectURL(pdfUrl);
						document.body.removeChild(link);

						halcoloaderRemove();
						DevExpress.ui.notify("descarga correcta", "success", { width: 450, displayTime: 8000 });
						// Limpia los campos y elimina las clases de validación
						for (let campo of campos) {
							campo.value = '';
							campo.classList.remove('is-valid');
							campo.classList.remove('is-invalid');
						}

						document.getElementById('trasladoPeligroso').checked = false;
						document.getElementById('trasladoFlex').checked = false;
						// Cierra el modal
						const modal = bootstrap.Modal.getInstance(document.getElementById('envioDeCorreo'));
						modal.hide();
					} else {
						let ms = responseData.data;
						DevExpress.ui.notify({ ms, width: 450, }, "error", 4000);
					}

				} catch (error) {
					// Manejo de errores
					if (error.name === 'TypeError') {
						let ms = error.message;
						// Esto ocurre si hay problemas de red o si la URL es incorrecta
						DevExpress.ui.notify({ ms, width: 450, }, "error", 4000);
						console.error('Problema de red o URL incorrecta:', error.message);
					} else if (error.message.startsWith('Error HTTP')) {
						// Si hubo un error HTTP (código de estado no 2xx)
						let ms = error.message;
						// Esto ocurre si hay problemas de red o si la URL es incorrecta
						DevExpress.ui.notify({ ms, width: 450, }, "error", 4000);
						console.error('Hubo un error al enviar los datos:', error.message);
					} else {
						let ms = error.message;
						// Esto ocurre si hay problemas de red o si la URL es incorrecta
						DevExpress.ui.notify({ ms, width: 450, }, "error", 4000);
						// Manejo de otros errores
						console.error('Error desconocido:', error.message);
					}
					halcoloaderRemove();
				}



			}
		});







	</script>

	<script>
		// Función para obtener el color dinámico
		function getBackgroundColor(item, cambio) {
			console.log(item);


			if (cambio == 1) {
				// Si está activo, azul; si no, amarillo
				if (item.activo || item.atendido == 1) {
					return "lightgreen"; // Color para elementos seleccionados
				} else {
					return "lightyellow"; // Color para elementos desmarcados
				}
			}

			if (cambio == 2) {
				// Si está activo, azul; si no, amarillo
				if (item.activo) {
					return "lightgreen"; // Color para elementos seleccionados
				} else {
					return "lightyellow"; // Color para elementos desmarcados
				}
			}

		}

		// Obtener referencia al botón y al div
		const btnCerrar = document.getElementById("btnCerrar");
		const dataFormulario = document.getElementById("dataFormulario");

		// Agregar evento de clic para cerrar el div
		btnCerrar.addEventListener("click", () => {
			dataFormulario.style.display = "none";
			document.getElementById("id_correo").value = -1;
			document.getElementById("correo_frm").value = "";
			document.getElementById("nombre_frm").value = "";
			document.getElementById("telefono_frm").value = "";

			document.getElementById("origen").value = "";
			document.getElementById("destino").value = "";
			document.getElementById("marca").value = "";
			document.getElementById("modelo").value = "";
			console.log("Formulario cerrado");
		});

		cargarCorreosFormulario = () => {
			// Realizar una solicitud GET
			fetch(urlEndPoint + '/ventas/get-data-form')
				.then(response => {
					if (!response.ok) {
						throw new Error(`HTTP error! Status: ${response.status}`);
					}
					return response.json(); // Convertir la respuesta a JSON
				})
				.then(data => {
					// Acceder al atributo 'data' de la respuesta
					console.log(data); // Toda la respuesta
					if (data.data) {
						const dropdown = $("#dropdown").dxDropDownBox({
							valueExpr: "id",
							displayExpr: "nombre",
							dataSource: data,
							contentTemplate: function (e) {
								const $list = $("<div>").dxList({
									dataSource: data.data,
									displayExpr: item => `${item.nombre} (${item.correo})`,
									itemTemplate: function (itemData) {
										// Crear contenedor para cada elemento
										const $container = $("<div>")
											.css("display", "flex")
											.css("align-items", "center")
											.css("padding", "5px")
											.css("border-radius", "4px")
											.css("cursor", "pointer")
											.css("background-color", getBackgroundColor(itemData, 1))
											.on("click", function () {
												// Registrar el ID del elemento seleccionado

												document.getElementById("txtnombrefrm").innerText = itemData.nombre;
												document.getElementById("txtcorreofrm").innerText = itemData.correo;
												document.getElementById("txttelefonofrm").innerText = itemData.telefono;
												document.getElementById("txtdatosvehiculofrm").innerText = itemData.datosVehiculo;
												document.getElementById("txtorigenfrm").innerText = itemData.origen;
												document.getElementById("txtdestinofrm").innerText = itemData.destino;
												document.getElementById("txtfechafrm").innerText = itemData.fecha;
												document.getElementById("txtcilindrosfrm").innerText = itemData.cilindros;
												document.getElementById("txtcaracteristicasfrm").innerText = itemData.caracteristicas;
												document.getElementById("id_correo").value = itemData.id;
												document.getElementById("correo_frm").value = itemData.correo;
												document.getElementById("nombre_frm").value = itemData.nombre;
												document.getElementById("telefono_frm").value = itemData.telefono;

												const switchElement = document.getElementById('chkLlenadoAutomatico').checked;

												origenchk = itemData.origen;
												destinochk = itemData.destino;
												marcachk = itemData.marca;
												modelochk = itemData.modelo;

												if (switchElement) {
													document.getElementById("origen").value = origenchk
													document.getElementById("destino").value = destinochk;
													document.getElementById("marca").value = marcachk;
													document.getElementById("modelo").value = modelochk;
												} else {
													document.getElementById("origen").value = "";
													document.getElementById("destino").value = "";
													document.getElementById("marca").value = "";
													document.getElementById("modelo").value = "";
												}

												// Mostrar el div si estaba oculto
												document.getElementById("dataFormulario").style.display = "block";
												console.log(`ID seleccionado: ${itemData.id}`);
												dropdown.dxDropDownBox("instance").close(); // Cierra el DropDownBox

											});

										// Checkbox con estado dinámico basado en la lógica
										const $checkbox = $("<input>")
											.attr("type", "checkbox")
											.prop("checked", itemData.activo || itemData.atendido == 1 || itemData.atendido == true) // Activo si `activo` es true o si `atendido === 1`
											.css("margin-right", "10px")
											.on("click", function (e) {
												e.stopPropagation(); // Prevenir que el clic cierre el DropDownBox
											})
											.on("change", function () {
												itemData.activo = $(this).is(":checked");
												$container.css("background-color", getBackgroundColor(itemData, 2));

												// Realizar una solicitud GET
												fetch(urlEndPoint + '/ventas/update-data-form', {
													method: 'PUT', // Cambiar el método a PUT
													headers: {
														'Content-Type': 'application/json' // Especificar que el cuerpo es JSON
													},
													body: JSON.stringify({
														// Datos que deseas enviar en el cuerpo de la solicitud
														id_correo_formulario: itemData.id
													})
												})
													.then(response => {
														if (!response.ok) {
															throw new Error(`HTTP error! Status: ${response.status}`);
														}
														return response.json(); // Convertir la respuesta a JSON
													})
													.then(data => {
														// Acceder al atributo 'data' de la respuesta
														console.log(data); // Toda la respuesta
													})
													.catch(error => {
														console.error("Error al obtener los datos:", error);
													});
												console.log(`Checkbox cambiado en ID: ${itemData.id}, Activo: ${itemData.activo}`);
											});

										// Texto del elemento
										const $text = $("<span>")
											.text(`${itemData.nombre} (${itemData.correo}) ${itemData.fecha} `);

										$container.append($checkbox).append($text);
										return $container;
									},
								});
								return $list;
							},
							placeholder: "Selecciona un registro",
							dropDownOptions: {
								width: "100%",
							},
						});

						console.log("Atributo 'data':", data.data); // Acceder a 'data'
					} else {
						console.log("'data' no se encuentra en la respuesta.");
					}
				})
				.catch(error => {
					console.error("Error al obtener los datos:", error);
				});

		}

	</script>

	<script>
		/*-------- Variables globales data */
		var guid_envio_mod = '';
		var id_envio_mod = -1;
		var precio_Combustible_mod = null;
		var factor_mod = null;
		var kilometros_mod = null;
		var casetas_Peajes_mod = null;
		var transporte_Origen_mod = null;
		var transporte_Destino_mod = null;
		var taxis_UBER_mod = null;
		var total_Extra_mod = null;
		var material_Bono_Extra_mod = null;
		var costo_ferry_mod = null;



		var dtTipoCalculo = null;
		var dtFactor = 1;
		var dtCombustible = null;

		var dataEmpresasGlobal = [];
		var dataAlmacenesGlobal = [];
		var modalCargaTemplate;
		var dataArchivosDescarga;
		var dataPrincipal;
		var empresaDescarga;
		var isMobile = false;



		var origenchk = "";
		var destinochk = "";
		var marcachk = "";
		var modelochk = "";

		var compUploadTemplate = {
			multiple: false, // Permitir cargar un solo archivo a la vez
			accept: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel", // Aceptar solo archivos Excel
			onValueChanged: function (e) {
				let dtFactor = $("#dtFactor").dxNumberBox("instance").option("value");
				let dtCombustible = $("#dtCombustible").dxNumberBox("instance").option("value");
				try {
					// Obtener el valor seleccionado utilizando el método option

					if (dtFactor === null || dtFactor <= 0) {
						throw "Debes ingresar un factor mayor a 0";
					}
					if (dtCombustible === null || dtCombustible <= 0) {
						throw "Debes ingresar un precio de combustible mayor a 0";
					}
				} catch (error) {
					let message = error;
					DevExpress.ui.notify({ message, width: 450, }, "error", 4000);
					//console.log(error);

				}

				if (dtFactor > 0 && dtCombustible > 0) {
					var files = e.value;
					if (files.length > 0) {
						var reader = new FileReader();
						reader.onload = function (e) {
							var data = e.target.result;
							// Convertir el contenido del archivo Excel a JSON
							var workbook = XLSX.read(data, { type: 'binary' });
							var sheetName = workbook.SheetNames[0];
							var worksheet = workbook.Sheets[sheetName];
							var excelData = XLSX.utils.sheet_to_json(worksheet, { raw: true });
							let excelValido = validarArrayTemplate(excelData);
							if (excelValido) {
								obtenerFacturasTemplate(excelData, 1);
							}
						};
						reader.readAsBinaryString(files[0]);

					}
				}
			}
		}

		$(document).ready(() => {

			halcoloaderActive();

			$("#rangoFechas").dxDateRangeBox({
				startDate: new Date(), // Fecha inicial
				endDate: new Date(),   // Fecha final
				displayFormat: "yyyy-MM-dd", // Formato de las fechas mostradas
				startDateLabel: "Desde", // Etiqueta para la fecha inicial
				endDateLabel: "Hasta",   // Etiqueta para la fecha final
				onValueChanged: function (e) {
					console.log("Rango seleccionado:", e.value);
				}
			});

			// Obtener el user-agent del navegador
			var userAgent = navigator.userAgent;
			// Verificar si el user-agent indica un dispositivo móvil
			isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
			//alert(isMobile);
			$("#titleModule").text("Calculo Traslado");

			$("#dtCombustible").dxNumberBox({
				value: 0.00, // Valor inicial con decimales
				min: 0.00, // Límite mínimo
				max: 100.00, // Límite máximo
				step: 0.01, // Incremento en pasos de 0.01
				showSpinButtons: true, // Mostrar botones de incremento/decremento
				format: "#,##0.00", // Formato con dos decimales
				onValueChanged: function (e) {
					console.log("Valor cambiado a: ", e.value);
					dtCombustible = e.value;
					//ocultarUpload();
				}
			});
			$("#dtFactor").dxNumberBox({
				value: 1.00, // Valor inicial con decimales
				min: 1.00, // Límite mínimo
				max: 100.00, // Límite máximo
				step: 0.01, // Incremento en pasos de 0.01
				showSpinButtons: true, // Mostrar botones de incremento/decremento
				format: "#,##0.00", // Formato con dos decimales
				onValueChanged: function (e) {
					console.log("Valor cambiado a: ", e.value);
					dtFactor = e.value;
					//ocultarUpload();
				}
			});

			$("#dtTipoCalculo").dxSelectBox({

				valueExpr: 'value',
				displayExpr: 'name',
				dataSource: [
					{ name: "Camiones", value: 1 },
					{ name: "Automóviles", value: 2 },
				], // Opciones de la lista
				placeholder: "Selecciona una opción", // Texto por defecto
				onValueChanged: function (e) {
					dtTipoCalculo = e.value;
					//ocultarUpload();

				}
			});

			// Inicializamos el dxPopup para usarlo como modal
			$("#myModal").dxPopup({
				visible: false,  // El popup comienza oculto
				showTitle: true,
				title: "Ver URL",
				width: "80%",
				height: "80%",
				dragEnabled: true, // Habilitar arrastre del modal
				closeOnOutsideClick: true // Cierra el popup si se hace clic fuera
			});

			cargarCorreosFormulario();

			generarGridSiniestros([], [], [], "#gridContainerSiniestro", "Siniestro", (isMobile) ? 10 : 260, (isMobile) ? 30 : 30);

			generarGridSiniestros([], [], [], "#gridContainerConsultaRegistros", "Registros", (isMobile) ? 10 : 260, (isMobile) ? 30 : 30);


			$("#fileUploaderContainer").dxFileUploader(compUploadTemplate);
			let confModalInfoTemplate = GeneratePopUp("Información estructura template");
			confModalInfoTemplate.width = (isMobile) ? "90%" : "90%";
			confModalInfoTemplate.height = (isMobile) ? "21%" : "30%";
			var modalInfoTemplate = $("#divInfoTemplate").dxPopup(confModalInfoTemplate).dxPopup("instance");
			let btnInfo = GenerateButton("+", "default");
			btnInfo.onClick = (e) => {
				modalInfoTemplate.show();
			}
			$("#btnInfoTemplate").dxButton(btnInfo);


			let btnInfoConsulta = GenerateButton("Consultar", "default");
			btnInfoConsulta.onClick = (e) => {
				obtenerFacturasTemplateConsulta();
			}
			$("#btnInfoConsultaRegistros").dxButton(btnInfoConsulta);

			let btnInfoCotizacionUnitaria = GenerateButton("Calculo Unitario", "default");
			btnInfoCotizacionUnitaria.onClick = (e) => {
				const campos = document.querySelectorAll('.validar-campo-formulario-datos'); // Selecciona todos los campos a validar
				for (let campo of campos) {
					campo.value = '';
					campo.classList.remove('is-valid');
					campo.classList.remove('is-invalid');
					if (campo.id === 'factor' || campo.name === 'factor') {
						campo.value = dtFactor; // Asignar valor por defecto
					}

					if (campo.id === 'precio_combustible' || campo.name === 'precio_combustible') {
						campo.value = dtCombustible; // Asignar valor por defecto
					}

					if (campo.id === 'id_correo' || campo.name === 'id_correo') {
						campo.value = -1; // Asignar valor por defecto
					}





					/*	const data = [
						{ id: 1, nombre: "Juan Pérez", correo: "juan.perez@example.com", atendido: 1, marca: "a", modelo: "", origen: "or",destino: "des",datosVehiculo: "ddd",fecha: "fdd", telefono:"3423432434",cilindros: "dd", caracteristicas: "ddd" },
						{ id: 2, nombre: "María López", correo: "maria.lopez@example.com", atendido: 0,  marca: "a", modelo: "", origen: "or",destino: "des", datosVehiculo: "ddd",fecha: "sdsd", telefono:"3423432434",cilindros: "dd", caracteristicas: "ddd" },
						{ id: 3, nombre: "Carlos Díaz", correo: "carlos.diaz@example.com", atendido: 1,  marca: "a", modelo: "", origen: "or",destino: "des",datosVehiculo: "ddd",fecha: "sds", telefono:"3423432434",cilindros: "dd", caracteristicas: "ddd"},
						{ id: 4, nombre: "Ana Sánchez", correo: "ana.sanchez@example.com", atendido: 0, marca: "a", modelo: "", origen: "or",destino: "des",datosVehiculo: "ddd",fecha: "sdd", telefono:"3423432434",cilindros: "dd", caracteristicas: "ddd"},
					];
								// Inicialización del DropDownBox
					
	*/
				}
				dataFormulario.style.display = "none";
				document.getElementById("id_correo").value = -1;
				var modalButton = document.getElementById('exampleModal');
				var myModal = new bootstrap.Modal(document.getElementById('exampleModal'));
				myModal.show();
			}
			$("#btnInfoCalculoUnitario").dxButton(btnInfoCotizacionUnitaria);

			//btnDescargarArchivos
			let btnDescarga = GenerateButton("Descargar", "default");
			btnDescarga.icon = "download";
			btnDescarga.onClick = (e) => {
				DescargarArchivo();
			}

			/* ----------- */
			//getFiltros();
			/* ----------- */
			setTimeout(function () {
				let miDiv = document.getElementById("ContainerBody");
				miDiv.style.display = "initial"; // Esto restablecerá el display a su valor predeterminado (por ejemplo, "block" para un <div>)
				// Restaurar el scroll

				halcoloaderRemove();
			}, 8000);  // 2000 milisegundos = 2 segundos

		});
		getFiltros = () => {
			getFiltrosAsync();
		}
		getFiltrosAsync = async () => {
			try {
				halcoloaderActive();
				let params = {}
				let response = await postData('/Reportes/FiltrosReporteSiniestros', params);
				dataEmpresasGlobal = response.Empresas;
				dataAlmacenesGlobal = response.Almacenes;
				$("#selectedBoxEmpresa").dxSelectBox("instance").option("dataSource", dataEmpresasGlobal);
				$("#dtCombustible").dxSelectBox("instance").option("dataSource", dataAlmacenesGlobal);

				halcoloaderRemove();
			} catch (e) {
				halcoloaderRemove();
			}
		}
		generarGridSiniestros = (data, itemsColumn, itemsSum, nameGrid, nameExcel, MinusHeight = 250, MinusWidth = 30) => {
			console.log(data);
			let _OpcionesDataGrid = GenerateDataGrid(data, itemsColumn, nameExcel);
			itemsSumGlobal = GridSumaryGenerator(itemsSum);
			console.log(_OpcionesDataGrid.columns);
			// Crear configuración de columnas para DevExtreme
			let configuracionColumnas = _OpcionesDataGrid.columns.map(columna => {
				// Especificar el tipo de dato y el formato para las columnas de cantidad
				let tipoDato = "string";
				let formato = "";
				let alignment = "center"
				let allowEditing = false;
				let visible = true;
				let fixed = false; // Fija esta columna
				if (["Precio_Combustible", "Costo_Combustible", "Alimentos", "Salario_Operador", "Hotel", "Placas_Urbanos", "Casetas_Peajes", "Transporte_Origen", "Transporte_Destino", "Taxis_UBER", "Total_Extra", "Material_Bono_Extra", "Costo_Ferry", "Utilidad", "SubTotal", "IVA", "Retencion", "Total_Persona", "Total_Empresa", "Costo_Violencia"].includes(columna)) {
					tipoDato = "number";
					formato = {
						type: "currency",
						precision: 2,
						currency: "MXN"
					};
					alignment = "right";
				}
				if (["Factor"].includes(columna)) {
					tipoDato = "number";
				}
				if (columna == "Kilometros" || columna == "Precio_Combustible" || columna == "Factor" || columna == "Casetas_Peajes" || columna == "Transporte_Origen" || columna == "Transporte_Destino" || columna == "Taxis_UBER" || columna == "Total_Extra" || columna == "Material_Bono_Extra" || columna == "Costo_Ferry") {
					allowEditing = true;
				}

				if (["Total_Porcentaje", "Consumo_Utilidad", "Salario_Operador_Por_Dia", "Hotel_Extra", "Dias_Extra_Calculo", "Ruta_Google_Maps", "Id", "Guid", "Id_correo", "Correo", "Nombre", "Telefono", "Porcentaje_Iva","Chat"].includes(columna)) {
					visible = false;
				}

				if (["Origen", "Destino", "Automovil"].includes(columna)) {
					fixed = true;
				}
				if (["Fecha_Creacion"].includes(columna)) {
					tipoDato = "date";
				}
				if (["Correo", "Nombre", "Telefono"].includes(columna) && nameGrid == "#gridContainerConsultaRegistros") {
					visible = true;
				}

				let width;
				if (["Tipo_Cotizacion"].includes(columna) && nameGrid == "#gridContainerConsultaRegistros") {
					width = 220;
				} else {
					width = 160;
				}

				return {
					dataField: columna,
					caption: columna.replace(/_/g, " "),
					width: width,
					dataType: tipoDato,
					format: formato,
					alignment: alignment,
					allowEditing: allowEditing,
					visible: visible,
					fixed: fixed
				};
			});

			if (data.length > 0) {
				configuracionColumnas.push({
					"caption": "Ruta",
					"width": 150,
					"datatype": "string",
					"alignment": "center",
					"allowEditing": false,
					"allowHiding": true,
					"cellTemplate": function (container, options) {
						$('<button>')
							.addClass('btn btn-primary btn-sm')
							.html('<i class="fas fa-route icon"></i> Visualizar ruta') // Ícono y texto del botón
							.on('click', function () {
								const url = options.data.Ruta_Google_Maps;
								if (url) {
									// Abre el enlace en una nueva pestaña
									window.open(url, '_blank');
								} else {
									alert("No se encontró la ruta.");
								}
							})
							.appendTo(container);
					}
				});

				configuracionColumnas.push({
					"caption": "Ruta",
					"width": 150,
					"datatype": "string",
					"alignment": "center",
					"allowEditing": false,
					"allowHiding": true,
					"cellTemplate": function (container, options) {
						$('<button data-bs-toggle="modal" data-bs-target="#envioDeCorreo">')
							.addClass('btn btn-primary btn-sm ')
							.html('<i class="fas fa-paper-plane icon"></i> Enviar correo') // Ícono y texto del botón
							.on('click', function () {

								guid_envio_mod = options.data.Guid;
								id_envio_mod = options.data.Id;
								console.log(options.data);

								precio_Combustible_mod = options.data.Precio_Combustible;
								factor_mod = options.data.Factor;
								kilometros_mod = options.data.Kilometros;
								casetas_Peajes_mod = options.data.Casetas_Peajes;
								transporte_Origen_mod = options.data.Transporte_Origen;
								transporte_Destino_mod = options.data.Transporte_Destino;
								taxis_UBER_mod = options.data.Taxis_UBER;
								total_Extra_mod = options.data.Total_Extra;
								material_Bono_Extra_mod = options.data.Material_Bono_Extra;
								costo_ferry_mod = options.data.Costo_Ferry;

								const campos = document.querySelectorAll('.validar-campo'); // Selecciona todos los campos a validar
								for (let campo of campos) {
									campo.value = '';
									campo.classList.remove('is-valid');
									campo.classList.remove('is-invalid');
								}
								document.getElementById('trasladoPeligroso').checked = false;
								document.getElementById('trasladoFlex').checked = false;


								document.getElementById("correo").value = options.data.Correo != undefined ? options.data.Correo : "";
								document.getElementById("nombre").value = options.data.Nombre != undefined ? options.data.Nombre : "";
								document.getElementById("telefono").value = options.data.Telefono != undefined ? options.data.Telefono : "";
								document.getElementById("txtIdCorreoEnvio").value = options.data.Id_correo != undefined ? options.data.Id_correo : -1;
								document.getElementById("trasladoFlex").checked = options.data.Traslado_Flex;

								// Buscar el valor específico
								//const itemCorreo = dataSource.find(item => options.data.id_correo === 4);

								console.log("correo seleccionado");
								//console.log(itemCorreo);


							})
							.appendTo(container);
					}
				});

				configuracionColumnas.push({
					"caption": "Chat",
					"width": 150,
					"datatype": "string",
					"alignment": "center",
					"allowEditing": false,
					"allowHiding": true,
					"cellTemplate": function (container, options) {
						if (options.data.Chat != null) {
							$('<button data-bs-toggle="modal" data-bs-target="#chatModal">')
							.addClass('btn btn-primary btn-sm ')
							.html('<i class="fas fa-message icon"></i> Ver chat') // Ícono y texto del botón
							.on('click', function () {

								console.log(options.data.Chat)

								//JSON.parse(options.data.Chat);

								let chat = options.data.Chat; // Reemplazar los valores excepto 'sql'
								chat = chat.replace(/`/g, ''); // Eliminar los backticks
								chat = chat.replace(/\n/g, '<br>'); // Reemplazar saltos de línea con <br>
								chat = chat.replace(/\r/g, ''); // Eliminar retornos de carro
								chat = chat.replace(/\t/g, '&nbsp;&nbsp;'); // Reemplazar tabulaciones con espacios no rompibles
								chat = chat.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

								const chatData = JSON.parse(chat); /*[
									{ sender: "bot", message: "Hola, ¿en qué puedo ayudarte?", time: "2025-02-21 10:00 AM" },
									{ sender: "bot", message: "Tenemos varias opciones para ti.", time: "2025-02-21 10:00 AM" },
									{ sender: "user", message: "Quiero saber más sobre sus servicios", time: "2025-02-21 10:01 AM" },
									{ sender: "user", message: "¿Tienen soporte técnico?", time: "2025-02-21 10:02 AM" },
									{ sender: "bot", message: "Sí, contamos con soporte técnico 24/7", time: "2025-02-21 10:03 AM" },
									{ sender: "bot", message: "También tenemos chat en vivo.", time: "2025-02-21 10:04 AM" },
									{ sender: "user", message: "¡Genial! ¿Cómo puedo contactarlos?", time: "2025-02-21 10:05 AM" }
								];*/

								const chatContainer = document.getElementById("chatContainer");
								chatContainer.innerHTML = "";

								chatData.forEach((chat) => {
									const chatMessage = document.createElement("div");
									chatMessage.classList.add("chat-message", chat.sender);

									const iconHTML = `<div class='chat-icon'><i class='fas ${chat.sender === "bot" ? "fa-robot" : "fa-user"}'></i></div>`;

									chatMessage.innerHTML = `
										${chat.sender === "bot" ? iconHTML : ""}
										<div class="chat-bubble">
											<p>${chat.message}</p>
											<small class="small-date">${chat.time}</small>
										</div>
										${chat.sender === "user" ? iconHTML : ""}
									`;

									chatContainer.appendChild(chatMessage);
								});
							})
							.appendTo(container);
						}
					
					}
				});

			}


			_OpcionesDataGrid.columns = configuracionColumnas;


			console.log(_OpcionesDataGrid);

			_OpcionesDataGrid.onCellPrepared = function (e) {
				try {

					var facturaProveedorValue = e.data.Factura_Proveedor;
					var dataField = e.column.dataField;

					if (dataField == "Kilometros" || dataField == "Precio_Combustible" || dataField == "Factor" || dataField == "Casetas_Peajes" || dataField == "Transporte_Origen" || dataField == "Transporte_Destino" || dataField == "Taxis_UBER" || dataField == "Total_Extra" || dataField == "Material_Bono_Extra" || dataField == "Costo_Ferry") {

						e.cellElement.css({
							"background-color": "silver",
							"color": "black"
						});
					}


					// Verificar si el valor de la columna es "cotización preliminar"
					if (e.value === "cotizacion manual automoviles") {
						e.cellElement.css({
							"background-color": "green",
							"color": "white"
						});
					}

					// Verificar si el valor de la columna es "cotización preliminar"
					if (e.value === "cotizacion preliminar (sin envio de correo)") {
						e.cellElement.css({
							"background-color": "yellow",
							"color": "black"
						});
					}

					// Verificar si el valor de la columna es "cotización preliminar"
					if (e.value === "cotizacion preliminar") {
						e.cellElement.css({
							"background-color": "#cce5ff",
							"color": "black"
						});
					}

				} catch (e) {

				}

			}
			/* _OpcionesDataGrid.onExporting = function (e) {
				//exportToExcel(dataPrincipal, "Reporte_Siniestros.xlsx"); // Reemplaza con el nombre deseado
				//e.cancel = true; // Cancelar la exportación predeterminada de DevExtreme
			} */

			_OpcionesDataGrid.onRowUpdating = function (e) {
				console.log("Datos antes de la actualización:", e.oldData);
				console.log("Datos nuevos:", e.newData);

				// Obtener los valores actualizados o mantener los valores anteriores
				let kilometros = e.newData.Kilometros !== undefined ? e.newData.Kilometros : e.oldData.Kilometros;
				let precioCombustible = e.newData.Precio_Combustible !== undefined ? e.newData.Precio_Combustible : e.oldData.Precio_Combustible;
				let consumo = e.newData.Consumo !== undefined ? e.newData.Consumo : e.oldData.Consumo;
				let porcentaje_iva = e.newData.Porcentaje_Iva !== undefined ? e.newData.Porcentaje_Iva : e.oldData.Porcentaje_Iva;

				let diasExtraCalculo = e.newData.Dias_Extra_Calculo !== undefined ? e.newData.Dias_Extra_Calculo : e.oldData.Dias_Extra_Calculo;

				let hotelExtra = e.newData.Hotel_Extra !== undefined ? e.newData.Hotel_Extra : e.oldData.Hotel_Extra;

				let totalPorcentaje = e.newData.Total_Porcentaje !== undefined ? e.newData.Total_Porcentaje : e.oldData.Total_Porcentaje;

				let consumoUtilidad = e.newData.Consumo_Utilidad !== undefined ? e.newData.Consumo_Utilidad : e.oldData.Consumo_Utilidad;

				let salarioOperadorPorDia = e.newData.Salario_Operador_Por_Dia !== undefined ? e.newData.Salario_Operador_Por_Dia : e.oldData.Salario_Operador_Por_Dia;


				let costoCombustible = precioCombustible * (kilometros / consumo);
				// Calcular el costo de combustible
				e.newData.Costo_Combustible = costoCombustible

				let diasTraslado = Math.ceil(kilometros / 650);
				e.newData.Dias_Traslado = diasTraslado;

				let alimentos = 300 * (diasTraslado + diasExtraCalculo /*1*/);
				e.newData.Alimentos = alimentos;

				let salarioOperador = /*450*/ salarioOperadorPorDia * (diasTraslado);
				e.newData.Salario_Operador = salarioOperador;

				let hotel = (diasTraslado > 1 ? (diasTraslado - 1) * 400 : 0) + hotelExtra/*800*/;
				e.newData.Hotel = hotel;

				let placasUrbanos = 50 + (40 * diasTraslado);
				e.newData.Placas_Urbanos = placasUrbanos;

				let casetasPeajes = e.newData.Casetas_Peajes !== undefined ? e.newData.Casetas_Peajes : e.oldData.Casetas_Peajes;
				let transporteOrigen = e.newData.Transporte_Origen !== undefined ? e.newData.Transporte_Origen : e.oldData.Transporte_Origen;
				let transporteDestino = e.newData.Transporte_Destino !== undefined ? e.newData.Transporte_Destino : e.oldData.Transporte_Destino;
				let taxisUBER = e.newData.Taxis_UBER !== undefined ? e.newData.Taxis_UBER : e.oldData.Taxis_UBER;
				let totalExtra = e.newData.Total_Extra !== undefined ? e.newData.Total_Extra : e.oldData.Total_Extra;
				let materialBonoExtra = e.newData.Material_Bono_Extra !== undefined ? e.newData.Material_Bono_Extra : e.oldData.Material_Bono_Extra;
				let costoFerry = e.newData.Costo_Ferry !== undefined ? e.newData.Costo_Ferry : e.oldData.Costo_Ferry;
				let costoViolencia = e.newData.Costo_Violencia !== undefined ? e.newData.Costo_Violencia : e.oldData.Costo_Violencia;
				let factor = e.newData.Factor !== undefined ? e.newData.Factor : e.oldData.Factor;

				//let utilidad = ((costoCombustible + alimentos + salarioOperador + hotel + placasUrbanos + casetasPeajes + transporteOrigen + transporteDestino + taxisUBER + totalExtra + materialBonoExtra + costoFerry + costoViolencia) * consumoUtilidad /*0.18*/) * factor;
				//e.newData.Utilidad = utilidad;

				//let subTotal = (costoCombustible + alimentos + salarioOperador + hotel + placasUrbanos + casetasPeajes + transporteOrigen + transporteDestino + taxisUBER + totalExtra + materialBonoExtra + costoFerry + costoViolencia) + utilidad;
				//e.newData.SubTotal = subTotal;
				let utilidad = (((costoCombustible * porcentaje_iva) + alimentos + salarioOperador + hotel + placasUrbanos + (casetasPeajes * porcentaje_iva) + (transporteOrigen * porcentaje_iva) + (transporteDestino * porcentaje_iva) + taxisUBER + totalExtra + materialBonoExtra + costoFerry + costoViolencia) * consumoUtilidad /*0.18*/) * factor;
				e.newData.Utilidad = utilidad;

				let subTotal = ((costoCombustible * porcentaje_iva) + alimentos + salarioOperador + hotel + placasUrbanos + (casetasPeajes * porcentaje_iva) + (transporteOrigen * porcentaje_iva) + (transporteDestino * porcentaje_iva) + taxisUBER + totalExtra + materialBonoExtra + costoFerry + costoViolencia) + utilidad;
				e.newData.SubTotal = subTotal;

				e.newData.IVA = subTotal * 0.16;

				e.newData.Retencion = subTotal * 0.04;
				e.newData.Total_Persona = (subTotal + (subTotal * 0.16)) * totalPorcentaje; /*1.1*/
				e.newData.Total_Empresa = (subTotal + (subTotal * 0.16) - (subTotal * 0.04)) * totalPorcentaje; /*1.1*/
				//console.log("Nuevo valor de Costo_Combustible:", e.newData.Costo_Combustible);

				// Actualizar el registro en el DataGrid
				e.component.getDataSource().store().update(e.key, e.newData)  // e.key es la clave primaria (ID)
					.then(function () {
						e.component.refresh();  // Refresca el DataGrid para reflejar los cambios
						//alert('Registro actualizado con cálculo realizado');
					})

			}
			$(nameGrid).dxDataGrid(_OpcionesDataGrid);
			ResizeGridExtreme(nameGrid, MinusHeight, MinusWidth);
		}

		/* 	function exportToExcel(data, fileName) {
				var headers = Object.keys(data[0]);
				// Crear libro y hoja de trabajo con ExcelJS
				var workbook = new ExcelJS.Workbook();
				var worksheet = workbook.addWorksheet("Sheet1");
				// Configurar ancho predeterminado de 100px para las primeras 16384 columnas
				var defaultColumnWidth = 20;
				var columnsToSetWidth = Math.min(headers.length, 16384);
				for (var i = 1; i <= columnsToSetWidth; i++) {
					worksheet.getColumn(i).width = defaultColumnWidth;
				}
				// Agregar encabezados de columna con color de fondo gris claro
				var headerRow = worksheet.addRow(headers);
				headerRow.eachCell({ includeEmpty: true }, function (cell) {
					cell.fill = {
						type: "pattern",
						pattern: "solid",
						fgColor: { argb: "DDDDDD" } // Gris claro
					};
				});
				// Agregar datos al libro
				data.forEach(function (rowData) {
					var row = worksheet.addRow(Object.values(rowData));
					// Obtener el índice de la columna "Articulo_proveedor"
					var columnIndex = headers.indexOf("Articulo_proveedor") + 1;
					// Verificar si Factura_Proveedor es null, undefined o vacío y aplicar estilo de fondo rojo a la celda
					var facturaProveedorValue = rowData["Factura_Proveedor"];
					if (!facturaProveedorValue || facturaProveedorValue.trim() === "") {
						var cell = row.getCell(columnIndex);
						cell.fill = {
							type: "pattern",
							pattern: "solid",
							fgColor: { argb: "FF0000" } // Rojo
						};
					}
				});
				// Agregar filtros
				worksheet.autoFilter = {
					from: {
						row: 1,
						column: 1
					},
					to: {
						row: 1,
						column: headers.length
					}
				};
				// Crear un blob y descargar el archivo
				workbook.xlsx.writeBuffer().then(function (buffer) {
					var blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
					var link = document.createElement("a");
					link.href = URL.createObjectURL(blob);
					link.download = fileName || "ExportedData.xlsx"; // Nombre del archivo predeterminado si no se proporciona
					link.click();
				});
			}
	*/

		/* 	validarArrayTemplate = (array) => {
				try {
	
					console.log(array)
					// Definimos la estructura esperada para cada objeto
					const estructuraEsperada = {
						"origen": "string",
						"destino": "string",
						"marca": "string",
						"modelo": "string",
						"consumo": "number",
						"numero_ejes": "number",
						"tipo_consumo": "string"
					};
					 // Validamos que el array tenga solo 6 columnas
					 if (Object.keys(estructuraEsperada).length !== 7) {
						throw "El template debe tener solo 7 columnas";
						return false;
					}
	
					// Recorremos cada objeto del array
					for (let i = 0; i < array.length; i++) {
						const obj = array[i];
	
						// Validamos que el objeto tenga las claves correctas
						for (let clave in estructuraEsperada) {
							if (!(clave in obj)) {
								throw `Falta la clave '${clave}' en el registro ${i}`;
								return false;
							}
	
							// Validamos que el tipo de cada valor sea el correcto
							if (typeof obj[clave] !== estructuraEsperada[clave]) {
								throw `El tipo de dato de la clave '${clave}' en el registro ${i} es incorrecto. Se esperaba '${estructuraEsperada[clave]}', pero se obtuvo '${typeof obj[clave]}'`;
								return false;
							}
	
							// Validamos que "Origen" tenga una coma
							if (!obj["Origen"].includes(",")) {
								throw `El campo 'Origen' en el registro ${i} debe contener esta estructura (municipio, estado)`;
								return false;
							}
	
							// Validamos que "Destino" tenga una coma
							if (!obj["Destino"].includes(",")) {
								throw `El campo 'Destino' en el registro ${i} debe contener esta estructura (municipio, estado)`;
								return false;
							}
	
						}
					}
					// Si todos los objetos son válidos
					//console.log("Todos los objetos son válidos.");
	
					return true;
				} catch (error) {
					let message = error;
					DevExpress.ui.notify({ message, width: 450, }, "error", 4000);
					return false;
				}
			}
	*/


		validarArrayTemplate = (array) => {
			try {
				console.log(array);

				// Definimos la estructura esperada para cada objeto
				const estructuraEsperada = {
					"origen": "string",
					"destino": "string",
					"marca": "string",
					"modelo": "string",
					"consumo": "number",
					"numero_ejes": "number",
					"tipo_consumo": "string"
				};

				// Validamos que el template tenga exactamente 7 columnas
				if (Object.keys(estructuraEsperada).length !== 7) {
					throw "El template debe tener solo 7 columnas";
				}

				// Recorremos cada objeto del array
				for (let i = 0; i < array.length; i++) {
					const obj = array[i];

					// Normalizamos las claves del objeto (convirtiéndolas a minúsculas)
					const objNormalizado = Object.keys(obj).reduce((acumulador, clave) => {
						acumulador[clave.toLowerCase()] = obj[clave];
						return acumulador;
					}, {});

					// Validamos que el objeto tenga las claves correctas
					for (let clave in estructuraEsperada) {
						if (!(clave in objNormalizado)) {
							throw `Falta la clave '${clave}' en el registro ${i}`;
						}

						// Validamos que el tipo de cada valor sea el correcto
						if (typeof objNormalizado[clave] !== estructuraEsperada[clave]) {
							throw `El tipo de dato de la clave '${clave}' en el registro ${i} es incorrecto. Se esperaba '${estructuraEsperada[clave]}', pero se obtuvo '${typeof objNormalizado[clave]}'`;
						}

						// Validamos que "origen" tenga una coma
						if (clave === "origen" && !objNormalizado[clave].includes(",")) {
							throw `El campo 'origen' en el registro ${i} debe contener esta estructura (municipio, estado)`;
						}

						// Validamos que "destino" tenga una coma
						if (clave === "destino" && !objNormalizado[clave].includes(",")) {
							throw `El campo 'destino' en el registro ${i} debe contener esta estructura (municipio, estado)`;
						}
					}
				}

				// Si todos los objetos son válidos
				return true;
			} catch (error) {
				let message = error;
				DevExpress.ui.notify({ message, width: 450 }, "error", 4000);
				return false;
			}
		};

		obtenerFacturasTemplate = (excelData, tipo) => {
			obtenerFacturasTemplateAsync(excelData, tipo);
		}

		obtenerFacturasTemplateConsulta = () => {
			obtenerFacturasTemplateconsultaAsync();
		}


		const obtenerFacturasTemplateconsultaAsync = async () => {
			halcoloaderActive(); // Activa el loader
			// Construcción del objeto de consulta

			let range = $("#rangoFechas").dxDateRangeBox("instance").option("value");
			let desde;
			let hasta;
			let nombreBusqueda = document.getElementById("txtBusquedaNombre").value;
			// Verificar si hay fechas seleccionadas
			if (range && range.length === 2) {
				var startDate = range[0]; // Fecha de inicio
				var endDate = range[1];   // Fecha de fin

				// Mostrar las fechas en el formato deseado
				desde = formatDate(startDate);
				hasta = formatDate(endDate);


				// Mostrar las fechas en el HTML
				const obj_consulta = {
					origen: desde,
					destino: hasta,
				};
				const urlAPI = urlEndPoint + `/ventas/get_data_registro_cotizaciones?desde=${desde}&hasta=${hasta}&nombre_busqueda=${nombreBusqueda}`;

				try {
					// Realizamos la solicitud POST
					const respuesta = await fetch(urlAPI, {
						method: 'GET',
						headers: {
							'Content-Type': 'application/json',
						},
					});

					// Verificamos si la respuesta fue exitosa
					if (!respuesta.ok) {
						throw new Error(`Error al hacer la solicitud`);
					}

					// Si la respuesta es exitosa, obtenemos los datos
					const resultados = await respuesta.json();
					console.log(resultados);

					if (resultados.data.length > 0) {

						let llaves = [
							"Id",
							"Guid",
							"Origen",
							"Destino",
							"Automovil",
							"Puntos_Intermedios_Asignados",
							"Precio_Combustible",
							"Factor",
							"Kilometros",
							"Consumo",
							"Tipo_Consumo",
							"Dias_Traslado",
							"Costo_Combustible",
							"Alimentos",
							"Salario_Operador",
							"Hotel",
							"Placas_Urbanos",
							"Casetas_Peajes",
							"Transporte_Origen",
							"Transporte_Destino",
							"Taxis_UBER",
							"Total_Extra",
							"Material_Bono_Extra",
							"Costo_Ferry",
							"Costo_Violencia",
							"Utilidad",
							"SubTotal",
							"IVA",
							"Retencion",
							"Total_Persona",
							"Total_Empresa",
							"Ruta_Google_Maps",
							"Total_Porcentaje",
							"Consumo_Utilidad",
							"Salario_Operador_Por_Dia",
							"Hotel_Extra",
							"Dias_Extra_Calculo",
							"Id_correo",
							"Correo",
							"Nombre",
							"Telefono",
							"Fecha_Creacion",
							"Tipo_Cotizacion",
							"Traslado_Flex",
							"Porcentaje_Iva",
							"Chat"
						]

						//Object.keys(resultados[0]);

						//console.log(llaves);
						let columnsSum = []

						generarGridSiniestros(resultados.data, llaves, columnsSum, "#gridContainerConsultaRegistros", "Reporte Descarga - Registros", (isMobile) ? 10 : 350, (isMobile) ? 30 : 30);


					} else {
						generarGridSiniestros([], [], [], "#gridContainerConsultaRegistros", "Reporte Descarga - Registros", (isMobile) ? 10 : 350, (isMobile) ? 30 : 30);

					}
					halcoloaderRemove(); // Desactiva el loader

				} catch (error) {
					console.error("Error en la solicitud:", error);

					halcoloaderRemove(); // Desactiva el loader
					return { error: true, message: "Ocurrió un error al realizar la solicitud." };
				}
			} else {
				halcoloaderRemove(); // Desactiva el loader
				let message = 'favor selecciona una fecha valida'
				DevExpress.ui.notify({ message, width: 450, }, "error", 4000);
			}


		};

		const obtenerFacturasTemplateAsync = async (excelData, tipo) => {
			halcoloaderActive();
			// URL de la API (ajústala a tu necesidad)
			const urlAPI = urlEndPoint + '/ventas/generate-cotizacion-preliminar-camiones-automoviles';

			console.log(excelData);
			// Array de promesas que contendrá las solicitudes HTTP
			const promesas = excelData.map(async (objeto) => {


				console.log("conslsssssss", objeto);
				objeto = Object.keys(objeto).reduce((acc, key) => {
					acc[key.toLowerCase()] = objeto[key];
					return acc;
				}, {});

				let obj_calculo = {
					"origen": objeto.origen,
					"destino": objeto.destino,
					"marca": objeto.marca,
					"modelo": objeto.modelo,
					"numero_cilindros": 0,
					"consumo": objeto.consumo == "" || objeto.consumo == null ? -1 : objeto.consumo,
					"numero_ejes": objeto.numero_ejes,
					"precio_combustible": tipo == 1 ? dtCombustible : objeto.precio_combustible,
					"factor": tipo == 1 ? dtFactor : objeto.factor,
					"tipo_consumo": objeto.tipo_consumo
				}
				let obj_calculoReturn = {
					"Origen": objeto.origen,
					"Destino": objeto.destino,
					"Automovil": objeto.marca + ' ' + objeto.modelo,
					"Consumo": objeto.consumo,
					"Ejes": objeto.numero_ejes,
					"Precio_Combustible": tipo == 1 ? dtCombustible : objeto.precio_combustible,
					"factor": tipo == 1 ? dtFactor : objeto.factor,
					"tipo_consumo": objeto.tipo_consumo
				}
				let intentos = 0; // Contador de intentos
				const maxIntentos = 10; // Número máximo de intentos
				let datos = null;

				while (intentos < maxIntentos) {
					try {
						console.log(`Intento ${intentos + 1} de ${maxIntentos}`);

						// Realizamos la solicitud POST enviando el objeto como cuerpo
						const respuesta = await fetch(urlAPI, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify(obj_calculo), // Convertimos el objeto a JSON
						});

						// Comprobamos si la respuesta fue exitosa
						if (!respuesta.ok) {
							throw new Error(`Error al hacer la solicitud para ${obj_calculo.drigen} a ${obj_calculo.destino}`);
						}

						// Si la respuesta es exitosa, obtenemos los datos
						datos = await respuesta.json();

						var button = document.querySelector('button.btn.btn-secondary[data-bs-dismiss="modal"]');
						if (button) {
							button.click(); // Simula un clic en el botón
						}

						datos.Id_correo = objeto.id_correo;
						datos.Correo = objeto.correo_frm;
						datos.Nombre = objeto.nombre_frm;
						datos.Telefono = objeto.telefono_frm;
						console.log(`Respuesta para ${obj_calculo.origen} a ${obj_calculo.destino}:`, datos);
						return datos; // Retornamos los datos si la solicitud fue exitosa

					} catch (error) {
						console.error(`Error en el intento ${intentos + 1}:`, error);

						intentos++; // Incrementamos el contador de intentos
						if (intentos >= maxIntentos) {
							console.error("Número máximo de intentos alcanzado. Abortando solicitud.");
							return obj_calculoReturn; // Devuelve un objeto de respaldo si se alcanzan los intentos máximos
						}
					}
				}
			});

			// Usamos Promise.all para esperar que todas las promesas se resuelvan
			try {

				console.log(promesas);

				const resultados = await Promise.all(promesas);

				if (resultados.length > 0) {
					$("#fileUploaderContainer").dxFileUploader("dispose");
					$("#fileUploaderContainer").dxFileUploader(compUploadTemplate);
					console.log('Resultados de todas las peticiones:', resultados);

					let llaves = [
						"Id",
						"Guid",
						"Origen",
						"Destino",
						"Automovil",
						"Puntos_Intermedios_Asignados",
						"Precio_Combustible",
						"Factor",
						"Kilometros",
						"Consumo",
						"Tipo_Consumo",
						"Dias_Traslado",
						"Costo_Combustible",
						"Alimentos",
						"Salario_Operador",
						"Hotel",
						"Placas_Urbanos",
						"Casetas_Peajes",
						"Transporte_Origen",
						"Transporte_Destino",
						"Taxis_UBER",
						"Total_Extra",
						"Material_Bono_Extra",
						"Costo_Ferry",
						"Costo_Violencia",
						"Utilidad",
						"SubTotal",
						"IVA",
						"Retencion",
						"Total_Persona",
						"Total_Empresa",
						"Ruta_Google_Maps",
						"Total_Porcentaje",
						"Consumo_Utilidad",
						"Salario_Operador_Por_Dia",
						"Hotel_Extra",
						"Dias_Extra_Calculo",
						"Id_correo",
						"Correo",
						"Nombre",
						"Telefono",
						"Traslado_Flex",
						"Porcentaje_Iva"
					]

					//Object.keys(resultados[0]);

					//console.log(llaves);
					let columnsSum = []

					generarGridSiniestros(resultados, llaves, columnsSum, "#gridContainerSiniestro", "Reporte Descarga", (isMobile) ? 10 : 350, (isMobile) ? 30 : 30);

				}

				halcoloaderRemove();

			} catch (error) {
				generarGridSiniestros([], [], [], "#gridContainerSiniestro", "Siniestro", (isMobile) ? 10 : 260, (isMobile) ? 30 : 30);
				$("#fileUploaderContainer").dxFileUploader("dispose");
				$("#fileUploaderContainer").dxFileUploader(compUploadTemplate);
				halcoloaderRemove();
				console.error('Hubo un error al realizar las peticiones:', error);

			}
		};

		ocultarUpload = () => {
			if (dtFactor >= 1 && dtTipoCalculo == 1 && dtCombustible > 0) {
				// Mostrar una alerta con el valor seleccionado
				let miDiv = document.getElementById("fileUploaderContainer");
				miDiv.style.display = "initial"; // Esto restablecerá el display a su valor predeterminado (por ejemplo, "block" para un <div>)
				// Restaurar el scroll
			} else {
				let miDiv = document.getElementById("fileUploaderContainer");
				miDiv.style.display = "none"; // Esto restablecerá el display a su valor predeterminado (por ejemplo, "block" para un <div>)
			}
		}
		/* DescargarArchivo = () => {
			download();
		}
		download = async () => {
			$(location).attr('href', '/Reportes/DownloadArchivosSiniestros');
		} */

		// Función para formatear las fechas en el formato deseado (yyyy-MM-dd)
		function formatDate(date) {
			try {
				var year = date.getFullYear();
				var month = ("0" + (date.getMonth() + 1)).slice(-2); // Mes con dos dígitos
				var day = ("0" + date.getDate()).slice(-2); // Día con dos dígitos
				return year + "-" + month + "-" + day;
			} catch (error) {
				halcoloaderRemove();
				let message = 'favor selecciona una fecha valida'
				DevExpress.ui.notify({ message, width: 450, }, "error", 4000);
			}

		}


		// Función para obtener el valor del switch
		function checkSwitchValue() {
			const switchElement = document.getElementById('chkLlenadoAutomatico').checked;


			if (switchElement) {
				document.getElementById("origen").value = origenchk;
				document.getElementById("destino").value = destinochk;
				document.getElementById("marca").value = marcachk;
				document.getElementById("modelo").value = modelochk;
			} else {
				document.getElementById("origen").value = "";
				document.getElementById("destino").value = "";
				document.getElementById("marca").value = "";
				document.getElementById("modelo").value = "";
			}
		}


		// Control de cierre del modal
		const chatModal = new bootstrap.Modal(document.getElementById("chatModal"));
		const chatCloseButton = document.getElementById("chatCloseButton");
		const chatCloseFooterButton = document.getElementById("chatCloseFooterButton");

		// No permitir cerrar al hacer clic fuera del modal
		chatCloseButton.addEventListener("click", function () {
			chatModal.hide();
		});

		chatCloseFooterButton.addEventListener("click", function () {
			chatModal.hide();
		});
	</script>

</html>
